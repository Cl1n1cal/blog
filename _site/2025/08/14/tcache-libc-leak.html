<!doctype html> <!-- `site.alt_lang` can specify a language different from the UI --> <html lang="" > <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta name="theme-color" media="(prefers-color-scheme: light)" content="#f7f7f7"> <meta name="theme-color" media="(prefers-color-scheme: dark)" content="#1b1b1e"> <meta name="mobile-web-app-capable" content="yes"> <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"> <meta name="viewport" content="width=device-width, user-scalable=no initial-scale=1, shrink-to-fit=no, viewport-fit=cover" ><!-- Setup Open Graph image --> <!-- Begin Jekyll SEO tag v2.8.0 --> <meta name="generator" content="Jekyll v4.4.1" /> <meta property="og:title" content="Libc leak with tcache enabled" /> <meta name="author" content="Cl1nical" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="Description When we have a UAF to read from a freed chunk how can we use this to get a libc leak? The tcache only stores its next ptrs and a key value, so we cannot leak libc through there. But if we could allocate and free more than what tcache can hold (7 chunks per bin) and then free another chunk that does not fit into fastbins, we might get it into unsortedbin. Unsortedbin contains libc ptrs to main arena." /> <meta property="og:description" content="Description When we have a UAF to read from a freed chunk how can we use this to get a libc leak? The tcache only stores its next ptrs and a key value, so we cannot leak libc through there. But if we could allocate and free more than what tcache can hold (7 chunks per bin) and then free another chunk that does not fit into fastbins, we might get it into unsortedbin. Unsortedbin contains libc ptrs to main arena." /> <link rel="canonical" href="http://localhost:4000/2025/08/14/tcache-libc-leak.html" /> <meta property="og:url" content="http://localhost:4000/2025/08/14/tcache-libc-leak.html" /> <meta property="og:site_name" content="Cl1nical’s cyber security blog" /> <meta property="og:type" content="article" /> <meta property="article:published_time" content="2025-08-14T06:50:19+02:00" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Libc leak with tcache enabled" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Cl1nical"},"dateModified":"2025-08-14T06:50:19+02:00","datePublished":"2025-08-14T06:50:19+02:00","description":"Description When we have a UAF to read from a freed chunk how can we use this to get a libc leak? The tcache only stores its next ptrs and a key value, so we cannot leak libc through there. But if we could allocate and free more than what tcache can hold (7 chunks per bin) and then free another chunk that does not fit into fastbins, we might get it into unsortedbin. Unsortedbin contains libc ptrs to main arena.","headline":"Libc leak with tcache enabled","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2025/08/14/tcache-libc-leak.html"},"url":"http://localhost:4000/2025/08/14/tcache-libc-leak.html"}</script> <!-- End Jekyll SEO tag --> <title>Libc leak with tcache enabled | Cl1nical's cyber security blog </title> <!-- The Favicons for Web, Android, Microsoft, and iOS (iPhone and iPad) Apps Generated by: https://realfavicongenerator.net/ --> <link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"> <link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"> <link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"> <link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"> <meta name="apple-mobile-web-app-title" content="Cl1nical's cyber security blog"> <meta name="application-name" content="Cl1nical's cyber security blog"> <meta name="msapplication-TileColor" content="#da532c"> <meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"> <meta name="theme-color" content="#ffffff"> <!-- Resource Hints --> <link rel="preconnect" href="https://fonts.googleapis.com" > <link rel="dns-prefetch" href="https://fonts.googleapis.com" > <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin> <link rel="dns-prefetch" href="https://fonts.gstatic.com" > <link rel="preconnect" href="https://cdn.jsdelivr.net" > <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" > <!-- Bootstrap --> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"> <!-- Theme style --> <link rel="stylesheet" href="/assets/css/jekyll-theme-chirpy.css"> <!-- Web Font --> <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"> <!-- Font Awesome Icons --> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.7.1/css/all.min.css"> <!-- 3rd-party Dependencies --> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.min.css"> <!-- Image Popup --> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox@3.3.0/dist/css/glightbox.min.css"> <!-- Scripts --> <script src="/assets/js/dist/theme.min.js"></script> <!-- JS selector for site. --> <!-- commons --> <!-- layout specified --> <!-- image lazy-loading & popup & clipboard --> <script defer src="https://cdn.jsdelivr.net/combine/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js,npm/loading-attribute-polyfill@2.1.1/dist/loading-attribute-polyfill.umd.min.js,npm/glightbox@3.3.0/dist/js/glightbox.min.js,npm/clipboard@2.0.11/dist/clipboard.min.js,npm/dayjs@1.11.13/dayjs.min.js,npm/dayjs@1.11.13/locale/en.js,npm/dayjs@1.11.13/plugin/relativeTime.js,npm/dayjs@1.11.13/plugin/localizedFormat.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <!-- Pageviews --> <!-- A placeholder to allow defining custom metadata --> </head> <body> <!-- The Side Bar --> <aside aria-label="Sidebar" id="sidebar" class="d-flex flex-column align-items-end"> <header class="profile-wrapper"> <a href="/" id="avatar" class="rounded-circle"><img src="/assets/images/avatar/profile.png" width="112" height="112" alt="avatar" onerror="this.style.display='none'"></a> <a class="site-title d-block" href="/">Cl1nical's cyber security blog</a> <p class="site-subtitle fst-italic mb-0"></p> </header> <!-- .profile-wrapper --> <nav class="flex-column flex-grow-1 w-100 ps-0"> <ul class="nav"> <!-- home --> <li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home"></i> <span>HOME</span> </a> </li> <!-- the real tabs --> </ul> </nav> <div class="sidebar-bottom d-flex flex-wrap align-items-center w-100"> <button type="button" class="btn btn-link nav-link" aria-label="Switch Mode" id="mode-toggle"> <i class="fas fa-adjust"></i> </button> </div> <!-- .sidebar-bottom --> </aside> <!-- #sidebar --> <div id="main-wrapper" class="d-flex justify-content-center"> <div class="container d-flex flex-column px-xxl-5"> <!-- The Top Bar --> <header id="topbar-wrapper" class="flex-shrink-0" aria-label="Top Bar"> <div id="topbar" class="d-flex align-items-center justify-content-between px-lg-3 h-100" > <nav id="breadcrumb" aria-label="Breadcrumb"> <span> <a href="/">Home</a> </span> <span>Libc leak with tcache enabled</span> </nav> <!-- endof #breadcrumb --> <button type="button" id="sidebar-trigger" class="btn btn-link" aria-label="Sidebar"> <i class="fas fa-bars fa-fw"></i> </button> <div id="topbar-title"> Main menu </div> <button type="button" id="search-trigger" class="btn btn-link" aria-label="Search"> <i class="fas fa-search fa-fw"></i> </button> <search id="search" class="align-items-center ms-3 ms-lg-0"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..." > </search> <button type="button" class="btn btn-link text-decoration-none" id="search-cancel">Cancel</button> </div> </header> <div class="row flex-grow-1"> <main aria-label="Main Content" class="col-12 col-lg-11 col-xl-9 px-md-4"> <!-- Refactor the HTML structure --> <!-- In order to allow a wide table to scroll horizontally, we suround the markdown table with `<div class="table-wrapper">` and `</div>` --> <!-- Fixed kramdown code highlight rendering: https://github.com/penibelst/jekyll-compress-html/issues/101 https://github.com/penibelst/jekyll-compress-html/issues/71#issuecomment-188144901 --> <!-- Change the icon of checkbox --> <!-- Handle images --> <!-- take out classes --> <!-- lazy-load images --> <!-- make sure the `<img>` is wrapped by `<a>` --> <!-- create the image wrapper --> <!-- combine --> <!-- take out classes --> <!-- lazy-load images --> <!-- make sure the `<img>` is wrapped by `<a>` --> <!-- create the image wrapper --> <!-- combine --> <!-- take out classes --> <!-- lazy-load images --> <!-- make sure the `<img>` is wrapped by `<a>` --> <!-- create the image wrapper --> <!-- combine --> <!-- Add header for code snippets --> <!-- Create heading anchors --> <!-- return --> <article class="px-1" data-toc="false"> <header> <h1 data-toc-skip>Libc leak with tcache enabled</h1> <div class="post-meta text-muted"> <!-- published date --> <span> Posted <!-- Date format snippet See: ${JS_ROOT}/utils/locale-dateime.js --> <time data-ts="1755147019" data-df="ll" data-bs-toggle="tooltip" data-bs-placement="bottom" > Aug 14, 2025 </time> </span> <!-- lastmod date --> <div class="d-flex justify-content-between"> <!-- author(s) --> <span> By <em> Cl1nical </em> </span> <div> <!-- pageviews --> <!-- read time --> <!-- Calculate the post's reading time, and display the word count in tooltip --> <!-- words per minute --> <!-- return element --> <span class="readtime" data-bs-toggle="tooltip" data-bs-placement="bottom" title="275 words" > <em>1 min</em> read</span> </div> </div> </div> </header> <div class="content"> <h3 id="description"><span class="me-2">Description</span><a href="#description" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3> <p>When we have a UAF to read from a freed chunk how can we use this to get a libc leak?<br /> The tcache only stores its next ptrs and a key value, so we cannot leak libc through there. But if we could allocate and free more than what tcache can hold (7 chunks per bin) and then free another chunk that does not fit into fastbins, we might get it into unsortedbin. Unsortedbin contains libc ptrs to main arena.</p> <h3 id="how-to-leak-libc-through-unsortedbin"><span class="me-2">How to leak libc through unsortedbin</span><a href="#how-to-leak-libc-through-unsortedbin" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3> <p>We are going to allocate and free 7 chunks to fill the tcache, 1 chunk to go into unsortedbin and a guard chunk to prevent top chunk consolidation. The chunks for tcache and unsortedbin are malloc(0x90) to prevent them from going into fastbin (larger than 64 bytes) and the guard chunk is only malloc(0x20) because its size does not matter. The POC program allows you to do arbitrary allocations of almost arbitrary size.<br /></p> <p><a href="/assets/images/others/unsortedbin.png" class="popup img-link shimmer"><img src="/assets/images/others/unsortedbin.png" style="width:100%; height:100%;" loading="lazy"></a> At address 0x555555559700 and 0x555555559708 you see that they contain the libc addresses of the unsortedbin. They are the fd and bk ptrs to the main arena.<br /></p> <p>At address 0x5555555597a0 you see the guard chunk user data. This guard chunk prevents top chunk consolidation and forces the previous chunk into the unsortedbin - just what we want.<br /></p> <p>Next up, the address from the unsortedbin chunk is leaked using the UAF bug in the POC binary. This Leak is at a fixed offset from libc base and this enables us to calculate libc base - finalizing our libc leak. The libc calculation is shown below:<br /> <a href="/assets/images/others/libc_calc.png" class="popup img-link shimmer"><img src="/assets/images/others/libc_calc.png" style="width:100%; height:100%;" loading="lazy"></a></p> <p>The picture below shows you the end result in the termina:<br /> <a href="/assets/images/others/libcleak.png" class="popup img-link shimmer"><img src="/assets/images/others/libcleak.png" style="width:100%; height:100%;" loading="lazy"></a></p> </div> <div class="post-tail-wrapper text-muted"> <!-- categories --> <!-- tags --> <div class=" post-tail-bottom d-flex justify-content-between align-items-center mt-5 pb-2 " > <div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author. </div> <!-- Post sharing snippet --> <div class="share-wrapper d-flex align-items-center"> <span class="share-label text-muted">Share</span> <span class="share-icons"> <button id="copy-link" aria-label="Copy link" class="btn small" data-bs-toggle="tooltip" data-bs-placement="top" title="Copy link" data-title-succeed="Link copied successfully!" > <i class="fa-fw fas fa-link pe-none fs-6"></i> </button> </span> </div> </div> <!-- .post-tail-bottom --> </div> <!-- div.post-tail-wrapper --> </article> </main> <!-- panel --> <aside aria-label="Panel" id="panel-wrapper" class="col-xl-3 ps-2 text-muted"> <div class="access"> <!-- Get 5 last posted/updated posts --> <section id="access-lastmod"> <h2 class="panel-heading">Recently Updated</h2> <ul class="content list-unstyled ps-0 pb-1 ms-1 mt-2"> <li class="text-truncate lh-lg"> <a href="/2025/08/14/tcache-libc-leak.html">Libc leak with tcache enabled</a> </li> <li class="text-truncate lh-lg"> <a href="/jekyll/update/2025/08/13/linux.html">Linux</a> </li> <li class="text-truncate lh-lg"> <a href="/2025/08/13/heap.html">Linux Heap</a> </li> <li class="text-truncate lh-lg"> <a href="/2025/08/13/poc-binary.html">POC Binary</a> </li> <li class="text-truncate lh-lg"> <a href="/2025/08/13/safe-linking.html">Safe Linking (tcache, fastbins)</a> </li> </ul> </section> <!-- #access-lastmod --> <!-- The trending tags list --> </div> </aside> </div> <div class="row"> <!-- tail --> <div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 px-md-4"> <!-- Recommend the other 3 posts according to the tags and categories of the current post. --> <!-- The total size of related posts --> <!-- An random integer that bigger than 0 --> <!-- Equals to TAG_SCORE / {max_categories_hierarchy} --> <!-- Navigation buttons at the bottom of the post. --> <nav class="post-navigation d-flex justify-content-between" aria-label="Post Navigation"> <a href="/2025/08/13/exploit-script.html" class="btn btn-outline-primary" aria-label="Older" > <p>Exploit script template - python</p> </a> <div class="btn btn-outline-primary disabled" aria-label="Newer"> <p>-</p> </div> </nav> <!-- The Footer --> <footer aria-label="Site Info" class=" d-flex flex-column justify-content-center text-muted flex-lg-row justify-content-lg-between align-items-lg-center pb-lg-3 " > <p>© <time>2025</time> <em class="fst-normal"></em>. <span data-bs-toggle="tooltip" data-bs-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span> </p> <p>Using the <a data-bs-toggle="tooltip" data-bs-placement="top" title="v7.3.1" href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener" >Chirpy</a> theme for <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a>. </p> </footer> </div> </div> <!-- The Search results --> <div id="search-result-wrapper" class="d-flex justify-content-center d-none"> <div class="col-11 content"> <div id="search-hints"> <!-- The trending tags list --> </div> <div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div> </div> </div> </div> <aside aria-label="Scroll to Top"> <button id="back-to-top" type="button" class="btn btn-lg btn-box-shadow"> <i class="fas fa-angle-up"></i> </button> </aside> </div> <div id="mask" class="d-none position-fixed w-100 h-100 z-1"></div> <!-- Embedded scripts --> <!-- The comments switcher --> <!-- Jekyll Simple Search loader See: <https://github.com/christian-fei/Simple-Jekyll-Search> --> <script> document.addEventListener('DOMContentLoaded', () => { SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: ' <article class="px-1 px-sm-2 px-lg-4 px-xl-0"> <header> <h2><a href="{url}">{title}</a></h2> <div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags} </div> </header> <p>{content}</p> </article>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="me-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); }); </script> </body> </html>
